- name: Restart WireGuard
  shell: |
    {{install_dir}}/wg_quick_wrapper.sh down {{install_dir}}/{{wireguard_iface}}.conf
    {{install_dir}}/wg_quick_wrapper.sh up {{install_dir}}/{{wireguard_iface}}.conf

- name: List OVS Ports
  shell: '{{install_dir}}/ovs_vsctl_wrapper.sh list-ports {{ovs_bridge}}'
  register: port_list_result

- name: Clean OVS Tunnels
  shell: '{{install_dir}}/ovs_vsctl_wrapper.sh del-port {{ovs_bridge}} {{item}}'
  when: item is match(geneve_tunnel_prefix + '*')
  with_items:
    - '{{port_list_result.stdout_lines}}'

- name: Create OVS Tunnels
  shell: >
    {{install_dir}}/ovs_vsctl_wrapper.sh add-port {{ovs_bridge}}
    {{geneve_tunnel_prefix}}{{hostvars[item].host_id}}
    -- set interface {{geneve_tunnel_prefix}}{{hostvars[item].host_id}} type=geneve
    options:remote_ip={{hostvars[item].host_id | get_wireguard_addr | ipaddr('address')}}
    options:key={{geneve_tunnel_key}}
  when: item != inventory_hostname
  with_inventory_hostnames:
    - all

- name: Restart DNS Server
  shell: '{{install_dir}}/run_dns_server.sh'
