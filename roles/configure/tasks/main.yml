- name: Restart WireGuard
  shell: |
    wg-quick down {{install_dir}}/{{wireguard_iface}}.conf
    wg-quick up {{install_dir}}/{{wireguard_iface}}.conf

- name: List OVS Ports
  shell: 'ovs-vsctl list-ports {{ovs_bridge}}'
  register: port_list_result

- name: Clean OVS Tunnels
  openvswitch_port:
    bridge: '{{ovs_bridge}}'
    port: '{{item}}'
    state: 'absent'
  when: item is match(geneve_tunnel_prefix + '*')
  with_items:
    - '{{port_list_result.stdout_lines}}'

- name: Create OVS Tunnels
  openvswitch_port:
    bridge: '{{ovs_bridge}}'
    port: '{{geneve_tunnel_prefix}}{{hostvars[item].host_id}}'
    state: 'present'
    set: >
      interface {{geneve_tunnel_prefix}}{{hostvars[item].host_id}} type=geneve
      options:remote_ip={{hostvars[item].host_id | get_wireguard_addr | ipaddr('address')}}
      options:key={{geneve_tunnel_key}}
  when: item != inventory_hostname
  with_inventory_hostnames:
    - all

- name: Restart DNS Server
  shell: 'ip netns exec {{namespace_name}} {{install_dir}}/run_dns_server.sh'
